<section class="workflow-mapping-container">
  <app-page-toolbar>
    <ng-container left>
    </ng-container>
    <ng-container right>
      <button
        ejs-button
        [isPrimary]="true"
        (click)="onAddMappingClick()"
      >Add Mapping</button>
    </ng-container>
  </app-page-toolbar>

  <ejs-grid class="grid grid-component"
            #grid
            appAddBackgroundForEmptyGridDirective
            (rowDataBound)="rowDataBound($event)"
            [dataSource]="(workflowMappings$ | async)?.items"
            [allowPaging]="allowPaging"
            [pageSettings]="pageSettings"
            [height]="gridHeight"
            [rowHeight]="rowHeight"
            [resizeSettings]="resizeSettings"
            [allowSorting]="allowSorting"
            [allowResizing]="allowResizing"
  >
    <ng-template #detailTemplate let-data>
      <table
        [appHighlightGridRowDirective]="data.hasUnassignedSteps"
        class="detailtable"
        width="100%"
        *ngFor="let type of [workflowTypes.OrderWorkflow, workflowTypes.ApplicationWorkflow]"
      >
        <colgroup>
          <col width="150">
          <col width="180">
          <col width="180">
          <col width="180">
          <col width="180">
          <col width="160">
          <col width="230">
          <col width="150">
          <col width="80">
        </colgroup>
        <thead>
          <tr>
            <td class="e-rowcell e-templatecell"></td>
            <td class="e-rowcell e-templatecell"></td>
            <td class="e-rowcell e-templatecell"></td>
            <td class="e-rowcell e-templatecell"></td>
            <td class="e-rowcell e-templatecell"></td>
            <td class="e-rowcell e-templatecell"></td>
            <td class="e-rowcell e-templatecell workflow-type">
              <span>{{ type === workflowTypes.OrderWorkflow ? 'ORDER' : 'APPLICATION' }}</span>
            </td>
            <td class="e-rowcell e-templatecell"></td>
            <td class="e-rowcell e-templatecell"></td>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let stepDetails of getStepDetails(data.stepMappings, data.workflowName, type)">
            <td class="e-rowcell e-templatecell"></td>
            <td class="e-rowcell e-templatecell"></td>
            <td class="e-rowcell e-templatecell"></td>
            <td class="e-rowcell e-templatecell"></td>
            <td class="e-rowcell e-templatecell"></td>
            <td class="e-rowcell e-templatecell"></td>
            <td class="e-rowcell e-templatecell workflow-type-content">
              <p>{{stepDetails.step.name + ' > ' + stepDetails.step.status}}</p>
            </td>
            <td class="e-rowcell e-templatecell user-roles-content">
              <p>{{stepDetails.roleUser?.name}}</p>
            </td>
            <td class="e-rowcell e-templatecell"></td>
          </tr>
        </tbody>
      </table>
    </ng-template>
    <e-columns>
      <e-column field="regionName" headerText="REGION" width=150>
        <ng-template #template let-data>
          <span *ngIf="data.regionId">{{ data.regionName }}</span>
          <span *ngIf="!data.regionId">All</span>
        </ng-template>
      </e-column>
      <e-column field="locationName" headerText="LOCATION" width=180>
        <ng-template #template let-data>
          <span *ngIf="data.locationId">{{ data.locationName }}</span>
          <span *ngIf="!data.locationId">All</span>
        </ng-template>
      </e-column>
      <e-column field="departmentName" headerText="DEPARTMENT" width=180>
        <ng-template #template let-data>
          <span *ngIf="data.departmentId">{{ data.departmentName }}</span>
          <span *ngIf="!data.departmentId">All</span>
        </ng-template>
      </e-column>
      <e-column field="skills" headerText="SKILL" width=170>
        <ng-template #template let-data>
          <span *ngFor="let skill of data.skills; let i = index">{{skill.skillDescription}}
            <span *ngIf="i !== data.skills.length - 1">, </span>
          </span>
          <span *ngIf="data.skills.length === 0">All</span>
        </ng-template>
      </e-column>
      <e-column headerText="WORKFLOW TYPE" width=180>
        <ng-template #template let-data>
          <span>Job Order Workflow</span>
        </ng-template>
      </e-column>
      <e-column field="workflowName" headerText="WORKFLOW NAME" width=180></e-column>
      <e-column headerText="CUSTOM STEP NAME" width=230></e-column>
      <e-column headerText="ROLE/USER" width=150></e-column>
      <e-column textAlign="Right" width=100>
        <ng-template #template let-data>
          <div class="row-tool-buttons">
            <button ejs-button cssClass="e-flat primary-icon-button" (click)="onEditButtonClick(data, $event)">
              <span class="edit-button"><i-feather name="edit" class="icon"></i-feather></span>
            </button>
            <button ejs-button cssClass="e-flat secondary-icon-button" (click)="onRemoveButtonClick(data, $event)">
              <span class="remove-button"><i-feather name="trash-2" class="icon"></i-feather></span>
            </button>
          </div>
        </ng-template>
      </e-column>
    </e-columns>
    <ng-template #pagerTemplate let-data>
      <div class="e-pagertemplate">
        <div class="control-section">
          <div class="content-wrapper">
            <section class="left-side-pager-controls">
              <ejs-dropdownlist
                id="rowsPerPage"
                class="dropdown-no-border"
                [dataSource]="rowsPerPageDropDown"
                [(value)]="activeRowsPerPageDropDown"
                (change)="onRowsDropDownChanged()"
              >
              </ejs-dropdownlist>
              <ejs-numerictextbox
                id="goToPage"
                class="numeric-input-no-border"
                format="#"
                [validateDecimalOnType]="validateDecimalOnType"
                [decimals]="decimals"
                placeholder="Go to:"
                min="1"
                [max]="(workflowMappings$ | async)?.totalPages"
                [showSpinButton]="false"
                (change)="onGoToClick($event)"
              >
              </ejs-numerictextbox>
            </section>
            <section class="right-side-pager-controls">
              <ejs-pager
                id="gridPager"
                #gridPager
                [pageSize]="pageSize"
                [totalRecordsCount]="(workflowMappings$ | async)?.totalCount"
                [enablePagerMessage]="false"
                [currentPage]="currentPage"
                (click)="onGoToClick($event)"
              >
              </ejs-pager>
            </section>
          </div>
        </div>
      </div>
    </ng-template>
  </ejs-grid>

  <app-side-dialog
    *ngIf="isActive"
    (formCancelClicked)="onCancelFormClick()"
    (formSaveClicked)="onSaveFormClick()"
    [header]="dialogHeader + ' Workflow'"
    [width]="'569'"
  >
    <form class="form-container bootstrap"
          id="addWorkflow"
          [formGroup]="workflowMappingFormGroup">

      <div>
        <div class="input-container dropdown">
          <label for="region">Region <span class="required">*</span></label>
          <div class="input-group dropdown">
            <ejs-multiselect
              id="region"
              #regionDropdown
              appValidateWithMessage
              placeholder="Region"
              selectAllText="Select All"
              mode="CheckBox"
              [dataSource]="orgRegions"
              [fields]="fields"
              [showSelectAll]="true"
              [allowFiltering]="false"
              [showDropDownIcon]="true"
              formControlName="regions"
            >
            </ejs-multiselect>
          </div>
        </div>
      </div>

      <div>
        <div class="input-container dropdown">
          <label for="location">Location <span class="required">*</span></label>
          <div class="input-group dropdown">
            <ejs-multiselect
              id="location"
              #locationDropdown
              appValidateWithMessage
              placeholder="Location"
              selectAllText="Select All"
              mode="CheckBox"
              [dataSource]="locations"
              [fields]="fields"
              [showSelectAll]="true"
              [allowFiltering]="false"
              [showDropDownIcon]="true"
              formControlName="locations">
            </ejs-multiselect>
          </div>
        </div>
      </div>

      <div>
        <div class="input-container dropdown">
          <label for="department">Department <span class="required">*</span></label>
          <div class="input-group dropdown">
            <ejs-multiselect
              id="department"
              #departmentDropdown
              appValidateWithMessage
              placeholder="Department"
              selectAllText="Select All"
              mode="CheckBox"
              [dataSource]="departments"
              [fields]="fields"
              [showSelectAll]="true"
              [allowFiltering]="false"
              [showDropDownIcon]="true"
              formControlName="departments">
            </ejs-multiselect>
          </div>
        </div>
      </div>

      <div>
        <div class="input-container dropdown">
          <label for="skill">Skill <span class="required">*</span></label>
          <div class="input-group dropdown">
            <ejs-multiselect
              id="skill"
              appValidateWithMessage
              placeholder="Skill"
              selectAllText="Select All"
              mode="CheckBox"
              [dataSource]="(skills$ | async)?.items"
              [fields]="skillsFields"
              [showSelectAll]="true"
              [allowFiltering]="false"
              [showDropDownIcon]="true"
              formControlName="skills">
            </ejs-multiselect>
          </div>
        </div>
      </div>

      <div>
        <div class="input-container dropdown">
          <label for="workflowType">Workflow Type <span class="required">*</span></label>
          <div class="input-group dropdown">
            <ejs-dropdownlist
              id="workflowType"
              appValidateWithMessage
              placeholder="Workflow Type"
              [dataSource]="workflowGroupTypesData"
              [fields]="workflowGroupTypesFields"
              formControlName="workflowType">
            </ejs-dropdownlist>
          </div>
        </div>
      </div>

      <div>
        <div class="input-container">
          <label for="workflowName">Workflow Name<span class="required">*</span></label>
          <div class="input-group dropdown">
            <ejs-dropdownlist
              id="workflowName"
              appValidateWithMessage
              placeholder="Workflow Name"
              [dataSource]="workflows$ | async"
              [fields]="fields"
              formControlName="workflowName"
            >
            </ejs-dropdownlist>
          </div>
        </div>
      </div>

      <div class="groups" *ngIf="isMappingSectionShown">
        <div class="group-container" formArrayName="orderRoleUserFormArray">
          <div class="group-name"><h3>Order</h3></div>
          <div class="group-details-container">
            <div class="group" *ngFor="let step of orderRoleUserFormArray.controls; let i = index">
              <div class="input-container without-label step-details">
                <div class="input-group input-readonly">
                  <input
                    class="e-input"
                    type="text"
                    readonly
                    [value]="orderWorkflowSteps[i].status + ' > ' + orderWorkflowSteps[i].nextStepStatus"
                  />
                </div>
              </div>

              <div class="input-container role-user">
                <label>Role/User <span class="required">*</span></label>
                <div class="input-group dropdown">
                  <ejs-multiselect
                    selectAllText="Select All"
                    mode="CheckBox"
                    [allowFiltering]="false"
                    [showDropDownIcon]="true"
                    placeholder="Role/User"
                    appValidateWithMessage
                    [dataSource]="rolesWithUsers"
                    [fields]="fields"
                    [formControlName]="i"
                  >
                  </ejs-multiselect>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="group-container" formArrayName="applicationRoleUserFormArray">
          <div class="group-name"><h3>Application</h3></div>
          <ng-container *ngFor="let step of applicationRoleUserFormArray.controls; let i = index">
            <div class="group" *ngIf="applicationWorkflowSteps[i].requirePermission">
              <div class="input-container without-label step-details">
                <div class="input-group input-readonly">
                  <input
                    class="e-input"
                    type="text"
                    readonly
                    [value]="applicationWorkflowSteps[i].status + ' > ' + applicationWorkflowSteps[i].nextStepStatus"
                  />
                </div>
              </div>

              <div class="input-container role-user">
                <label>Role/User <span class="required">*</span></label>
                <div class="input-group dropdown">
                  <ejs-multiselect
                    selectAllText="Select All"
                    mode="CheckBox"
                    [allowFiltering]="false"
                    [showDropDownIcon]="true"
                    placeholder="Role/User"
                    appValidateWithMessage
                    [dataSource]="rolesWithUsers"
                    [fields]="fields"
                    [formControlName]="i"
                  >
                  </ejs-multiselect>
                </div>
              </div>
            </div>
          </ng-container>
        </div>
      </div>
    </form>
  </app-side-dialog>
</section>
