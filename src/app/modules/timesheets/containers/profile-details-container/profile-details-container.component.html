<ejs-dialog
  id="dialog"
  #candidateDialog
  cssClass="dialog timesheet-details-dialog"
  [target]="targetElement"
  [width]="'1180px'"
  [visible]="false"
  [isModal]="true"
  [animationSettings]="{ effect: 'SlideRight' }"
  (open)="onOpen($event)"
>
  <ng-template #content>
    <section class="container" *ngIf="timesheetDetails$ | async as timesheetDetails; else closeTemplate" #resize>
      <div class="profile-details">
        <div class="profile-details__wraper">
          <div class="profile-details__info-container">
            <div class="profile-details__info">
              <img
                class="e-avatar e-avatar-xlarge"
                alt="avatar"
                [src]="timesheetDetails.candidateId | candidateAvatar"
              />

              <div class="profile-details__user-name">
                <h3 class="username">
                  {{ timesheetDetails.candidateLastName }}, {{ timesheetDetails.candidateFirstName }}
                </h3>
                <ng-container *ngIf="!isMobile">
                  <ng-container
                    [ngTemplateOutlet]="test"
                    [ngTemplateOutletContext]="{ timesheetDetails }"
                  ></ng-container>
                </ng-container>
              </div>
            </div>
            <div *ngIf="isMobile" class="profile-details__chip-list">
              <ng-container [ngTemplateOutlet]="test" [ngTemplateOutletContext]="{ timesheetDetails }"></ng-container>
            </div>
          </div>

          <div class="profile-details__header-controls">
            <div style="display: flex; align-items: center" class="timesheet-details-upload-container" #uploadContainer>
              <app-date-week-picker
                *ngIf="!isMobile"
                [initDates]="weekPeriod"
                [availibleDates]="workWeeks"
                [isAbleToChange]="isChangesSaved"
              >
              </app-date-week-picker>

              <app-upload-button
                *ngIf="!responsiveTablet; else tabletButton"
                [disabled]="disableAnyAction || timesheetDetails.noWorkPerformed || !timesheetDetails.canUploadFiles"
                [hasPermission]="hasEditTimesheetRecordsPermission"
                [container]="uploadContainer"
                (filesSelected)="onFilesSelected($event)"
              ></app-upload-button>

              <!--TODO: (style="display: none") temporary solution to hide the export button EIN-5900-->
              <app-export-button
                style="display: none"
                (csvExport)="exportProfileDetails(exportedFileType.csv)"
                (excelExport)="exportProfileDetails(exportedFileType.excel)"
                (customExport)="showCustomExportDialog()"
              ></app-export-button>
            </div>
            <ng-template #tabletButton>
              <button
                ejs-dropdownbutton
                [items]="mobileMenu"
                [disabled]="disableAnyAction || timesheetDetails.noWorkPerformed || !timesheetDetails.canUploadFiles"
                (select)="onMobileMenuSelect($event)"
                iconCss="e-icons"
                cssClass="e-caret-hide primary-icon-button menu-mobile"
              >
                <i-feather name="more-vertical" class="icon"></i-feather>
              </button>
            </ng-template>

            <button ejs-button type="submit" cssClass="e-flat close-button" (click)="handleProfileClose()">
              <i-feather name="x" class="icon"></i-feather>
            </button>
          </div>
        </div>
        <div *ngIf="isMobile" class="profile-details__mobile-date-picker">
          <app-date-week-picker [initDates]="weekPeriod" [availibleDates]="workWeeks" [isAbleToChange]="isChangesSaved">
          </app-date-week-picker>
        </div>
      </div>

      <div class="order-header">
        <div class="order-meta">
          <h2 class="order-id">Job ID: {{ timesheetDetails?.formattedId }}</h2>
        </div>

        <div class="controls-wrapper">
          <div class="reject-reason-block" *ngIf="timesheetDetails?.rejectionReason as rejectReason">
            <span class="reason-header">Reject Reason:</span>
            <ejs-tooltip [content]="rejectReason" class="reject-tooltip">
              <span class="reason-text">{{ rejectReason }}</span>
            </ejs-tooltip>
          </div>

          <div class="controls-block">
            <div class="checkbox-block" *ngIf="isDNWEnabled">
              <ejs-switch
                #dnwSwitch
                class="toggle"
                [disabled]="disableAnyAction || !hasEditTimesheetRecordsPermission"
                [checked]="timesheetDetails.noWorkPerformed"
                (change)="onDWNCheckboxSelectedChange($event, dnwSwitch)"
              ></ejs-switch>
              <span>DNW</span>
            </div>
          </div>
        </div>
      </div>

      <div class="job-general-info tile-dark-blue">
        <app-profile-details-job-info [isAgency]="isAgency" [jobData]="timesheetDetails"></app-profile-details-job-info>
      </div>

      <div class="profile-hours-statistics">
        <div class="tile-dark-blue statistic-wrapper">
          <app-profile-cumulative-hours
            [statisticsData]="timesheetDetails.timesheetStatistic.timesheetStatisticDetails"
          ></app-profile-cumulative-hours>
        </div>

        <div class="tile-dark-blue miles" *ngIf="milesData$ | async as milesData">
          <app-profile-miles [milesData]="milesData"></app-profile-miles>
        </div>

        <div
          class="tile-dark-blue profile-attachments"
          *ngIf="!timesheetDetails.noWorkPerformed && timesheetDetails?.attachments?.length"
        >
          <h3 class="attachments-title">Attachments</h3>

          <app-attachments-list
            [attachments]="timesheetDetails.attachments"
            [attachmentsListConfig]="attachmentsListConfig$ | async"
            [deleteIconColor]="'#FF5858'"
            [disableDelete]="disableAnyAction || !hasEditTimesheetRecordsPermission"
          ></app-attachments-list>
        </div>

        <div class="tile-dark-blue profile-invoices" *ngIf="timesheetDetails?.invoices?.length">
          <app-profile-invoices [invoices]="timesheetDetails.invoices"></app-profile-invoices>
        </div>
      </div>

      <section class="profile-table-container">
        <app-profile-timesheet-table
          [isAgency]="isAgency"
          [timesheetDetails]="timesheetDetails"
          [actionsDisabled]="timesheetDetails.noWorkPerformed"
          [disableAnyAction]="disableAnyAction"
          [hasEditTimesheetRecordsPermission]="hasEditTimesheetRecordsPermission"
          [hasApproveRejectMileagesPermission]="
            isAgency ? true : userPermission[userPermissions.CanOrganizationApproveRejectMileages]
          "
          (openAddSideDialog)="openAddDialog($event)"
          (uploadSideDialog)="openUploadSideDialog($event)"
          (changesSaved)="handleEditChanges($event)"
          (rejectEvent)="onRejectButtonClick($event)"
          (approveEvent)="handleApprove($event)"
          (orgSubmitting)="orgSubmit()"
        >
        </app-profile-timesheet-table>
      </section>
    </section>
    <ng-template #closeTemplate>
      <section class="container d-flex justify-end">
        <button ejs-button type="submit" cssClass="e-flat close-button" (click)="handleProfileClose()">
          <i-feather name="x" class="icon"></i-feather>
        </button>
      </section>
    </ng-template>
    <app-navigation-panel
      prevLabel="Previous Timesheet"
      nextLabel="Next Timesheet"
      [prevDisabled]="currentSelectedRowIndex === 0"
      [nextDisabled]="isNextDisabled"
      (prevClick)="onNextPreviousOrder(false)"
      (nextClick)="onNextPreviousOrder(true)"
    ></app-navigation-panel>
  </ng-template>
</ejs-dialog>

<app-reject-reason-input-dialog
  [(visible)]="rejectReasonDialogVisible"
  [container]="candidateDialog.element"
  (rejectReasonChange)="handleReject($event)"
></app-reject-reason-input-dialog>

<app-add-timesheet></app-add-timesheet>

<app-upload-documents (fileChange)="saveFilesOnRecord($event)"></app-upload-documents>

<app-export-dialog
  [columns]="columnsToExport"
  [fileName]="fileName"
  (cancel)="closeExport()"
  (export)="customExport($event)"
></app-export-dialog>

<app-file-viewer></app-file-viewer>

<ng-template #test let-timesheetDetails="timesheetDetails">
  <ejs-tooltip id="tooltip" #tooltip target=".e-chip" (beforeRender)="beforeRender($event)">
    <ejs-chiplist #chipList>
      <e-chips>
        <e-chip [text]="timesheetDetails.statusText" [cssClass]="timesheetDetails.statusText || '' | chipsCssClass">
        </e-chip>
        <e-chip
          *ngIf="isMileageStatusAvailable"
          [text]="timesheetDetails.mileageStatusText"
          [cssClass]="timesheetDetails.mileageStatusText || '' | chipsCssClass"
        >
        </e-chip>
      </e-chips>
    </ejs-chiplist>
  </ejs-tooltip>
</ng-template>
