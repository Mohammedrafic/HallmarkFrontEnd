<app-page-toolbar>
  <ng-container left>
    <button *ngIf="!isAgencyUser" ejs-button cssClass="e-outline" (click)="onBack()">Back</button>
    <h3>{{ title }} Agency</h3>
  </ng-container>
  <ng-container right>
    <ng-container *ngIf="!isSeccondStepActive">
      <button [disabled]="!agencyForm?.dirty" ejs-button cssClass="e-outline" (click)="onClear()">Clear</button>
      <app-tooltip-container
        [message]="toolTipMessage"
        [showToolTip]="!userPermission[userPermissions.CanEditAgencyProfile]">
        <button
          ejs-button
          [disabled]="(activeUser.businessUnitType === businessUnitType.Agency && (activeUser.agencyStatus === agencyStatus.Inactive || activeUser.agencyStatus === agencyStatus.Terminated))|| !userPermission[userPermissions.CanEditAgencyProfile]"
          [isPrimary]="true"
          (click)="onSave()">Save</button>
      </app-tooltip-container>
    </ng-container>
  </ng-container>
</app-page-toolbar>

<ejs-tab class="stepper" #stepper (created)="onStepperCreated()">
  <e-tabitems>
    <e-tabitem>
      <ng-template #headerText>
        <div class="stepper-header required">
          <div class="stepper-title">General Info</div>
          <div class="stepper-sub-title">Overall Agency Info</div>
        </div>
      </ng-template>
      <ng-template #content>
        <!-- General info step -->
        <form [formGroup]="agencyForm" id="agencyFormFirstStep">
          <div class="dropdown-container bootstrap create-under" *ngIf="createUnderAvailable && !isEditMode">
            <label>Create Under<span class="required">*</span></label>
            <div class="input-group dropdown">
              <ejs-dropdownlist
                appValidateWithMessage
                formControlName="parentBusinessUnitId"
                [fields]="createUnderFields"
                [allowFiltering]="true"
                [dataSource]="businessUnits$ | async"
              ></ejs-dropdownlist>
            </div>
          </div>

          <section class="general-info-container">
            <div class="left">
              <div class="e-card">
                <div class="e-card-header">
                  <div class="e-card-header-caption">
                    <div class="e-card-title">Agency Details</div>
                    <div *ngIf="agencyIsMsp" class="msp-agency">
                      <ejs-chiplist>
                        <e-chips>
                          <e-chip text="Is Msp" cssClass="e-success msp-chip"></e-chip>
                        </e-chips>
                      </ejs-chiplist>
                    </div>
                  </div>
                </div>

                <div class="e-card-content">
                  <app-general-info-group
                    [isAgencyUser]="isAgencyUser"
                    [isHallmarkUser]="isHallmarkUser"
                    [isCreating]="!isEditMode"
                    [agencyIsMsp]="agencyIsMsp"
                    [formGroup]="$any(agencyControl)"
                    (mspCheckboxEmitter)="onMspCheckboxChecked($event)"></app-general-info-group>

                  <div class="e-card-title-wrapper">
                    <div class="e-card-title">Job Distribution</div>
                  </div>
                  <app-job-distribution [formGroup]="$any(distributionControl)"></app-job-distribution>

                  <div class="e-card-title-wrapper">
                    <div class="e-card-title">Billing Details</div>
                  </div>

                  <div class="billing-checkbox bootstrap">
                    <ejs-checkbox formControlName="isBillingPopulated" label="Same As Agency"></ejs-checkbox>
                  </div>
                  <app-billing-details-group [formGroup]="$any(billingControl)"></app-billing-details-group>

                  <div class="e-card-title-wrapper contact-header">
                    <div class="e-card-title">Contact Details</div>
                    <app-tooltip-container class="stick-right" [showToolTip]="!userPermission[userPermissions.CanEditAgencyProfile]">
                      <button
                        [disabled]="!userPermission[userPermissions.CanEditAgencyProfile]"
                        ejs-button
                        cssClass="e-outline add-contact-link"
                        (click)="addContact()">
                        <i-feather name="plus" class="icon"></i-feather> Add Contact
                      </button>
                    </app-tooltip-container>
                  </div>
                  <hr />
                  <ng-container *ngFor="let contactGroup of contacts.controls; let i = index">
                    <app-contact-details-group
                      [formGroup]="$any(contactGroup)"
                      [isRemovable]="contacts.length > 1"
                      (deleteContactEvent)="deleteContact(i)"
                    ></app-contact-details-group>
                    <hr />
                  </ng-container>
                </div>
              </div>
            </div>
            <div class="right">
              <app-image-uploader uploaderTitle="Logo" [logo]="logo" (selectImage)="onImageSelect($event)"></app-image-uploader>
            </div>
          </section>
          <section class="payment-section last-content-section-padding">
            <app-payment-details-grid
              [paymentsFormArray]="$any(agencyForm?.get('agencyPaymentDetails'))"
              [hasPermissions]="userPermission[userPermissions.CanEditAgencyProfile]"
            ></app-payment-details-grid>
          </section>
        </form>
      </ng-template>
    </e-tabitem>
  </e-tabitems>
</ejs-tab>
